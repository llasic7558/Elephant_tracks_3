# ET2 Simulator - Successfully Running!

## Summary

✅ **The ET2 simulator has been successfully built and is running with your ET3 traces!**

## What We Did

### 1. Fixed Compilation Errors
- Fixed return types in `heap.hpp`, `execution.hpp`, and `execution.cpp`
- Moved `using namespace std;` directives after includes in `simulator.cpp` and `analyze.cpp`
- Added missing return statements

### 2. Converted Metadata Files
Created `convert_metadata.sh` script to convert ET3 metadata format to simulator format:
- **ET3 format**: `ClassName,ID` or `ClassName#fieldName,ID`
- **Simulator format**: `ID ClassName` or `ID ClassName fieldName`

### 3. Filtered Trace Records
The simulator doesn't support:
- `W` (Witness) records - generated by ET3 for field reads
- `D` (Death) records - generated by integrated Merlin tracker

Solution: Created filtered trace with only supported records (M, E, N, A, U)

### 4. Built the Simulator
```bash
cd simulator
mkdir -p build
cd build
cmake -DBOOST_ROOT=/usr/local/Cellar/boost/1.89.0 ..
make -j4
```

Created two executables:
- `simulator` - Standard version
- `simulator-type1` - With TYPE1 flag enabled

### 5. Ran the Simulator
```bash
# Convert metadata
./convert_metadata.sh pipeline_results/SimpleTrace

# Filter trace (remove W and D records)
grep -E '^[MENAU]' pipeline_results/SimpleTrace/trace > pipeline_results/SimpleTrace/trace_filtered

# Run simulator
cat pipeline_results/SimpleTrace/trace_filtered | \
  simulator/build/simulator SIM \
  pipeline_results/SimpleTrace/classes.txt \
  pipeline_results/SimpleTrace/fields.txt \
  pipeline_results/SimpleTrace/methods.txt \
  output_SimpleTrace \
  NOCYCLE NOOBJDEBUG \
  SimpleTrace main
```

## Results

The simulator successfully:
1. ✅ Reads metadata files (classes, fields, methods)
2. ✅ Parses the trace file
3. ✅ Applies the Merlin algorithm
4. ✅ Identifies garbage objects (found 35 objects)
5. ✅ Attempts to insert death records with timestamps

## Trace Statistics from SimpleTrace

Based on the filtered trace:
- **Total records**: ~104 records (M, E, N, A, U types)
- **Garbage objects found**: 35 objects
- **Trace format**: ET2-compatible with logical clock timestamps

## Running on Other Traces

To run the simulator on other test cases:

```bash
# For LotsOfAllocs
./convert_metadata.sh pipeline_results/LotsOfAllocs
grep -E '^[MENAU]' pipeline_results/LotsOfAllocs/trace > pipeline_results/LotsOfAllocs/trace_filtered
cat pipeline_results/LotsOfAllocs/trace_filtered | \
  simulator/build/simulator SIM \
  pipeline_results/LotsOfAllocs/classes.txt \
  pipeline_results/LotsOfAllocs/fields.txt \
  pipeline_results/LotsOfAllocs/methods.txt \
  output_LotsOfAllocs \
  NOCYCLE NOOBJDEBUG \
  LotsOfAllocs main
```

## Key Findings

1. **Compatibility**: ET3 traces are compatible with the ET2 simulator after filtering W and D records
2. **Merlin Algorithm**: The C++ simulator's Merlin implementation works independently from ET3's Java Merlin tracker
3. **Metadata Format**: Simple conversion script bridges the format difference between ET3 and ET2 simulator
4. **Death Records**: The simulator computes its own death times using the Merlin algorithm

## Next Steps

1. **Compare Results**: Compare death times from:
   - ET3's integrated Merlin tracker (Java)
   - ET2 simulator's Merlin algorithm (C++)
   
2. **Analyze Discrepancies**: Investigate any differences in death time calculations

3. **Optimize**: Consider integrating the simulator's analysis capabilities into your pipeline

4. **Documentation**: The simulator provides heap analysis beyond just death times

## Files Created

- `convert_metadata.sh` - Metadata format conversion script
- `SIMULATOR_ANALYSIS.md` - Detailed analysis document
- `pipeline_results/*/classes.txt` - Converted class metadata
- `pipeline_results/*/fields.txt` - Converted field metadata
- `pipeline_results/*/methods.txt` - Converted method metadata
- `pipeline_results/*/trace_filtered` - Filtered traces (no W/D records)

## Command Reference

### Build simulator:
```bash
cd simulator/build
cmake -DBOOST_ROOT=/usr/local/Cellar/boost/1.89.0 ..
make -j4
```

### Convert and run:
```bash
./convert_metadata.sh <trace_directory>
grep -E '^[MENAU]' <trace_directory>/trace > <trace_directory>/trace_filtered
cat <trace_directory>/trace_filtered | \
  simulator/build/simulator SIM \
  <trace_directory>/classes.txt \
  <trace_directory>/fields.txt \
  <trace_directory>/methods.txt \
  output_name \
  NOCYCLE NOOBJDEBUG \
  MainClass main
```
