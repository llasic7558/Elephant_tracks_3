# Elephant Tracks Trace Format with Merlin Death Records

## Overview

This document describes the trace file format expected by the TraceReplayer. The format is based on Elephant Tracks (ET) with Merlin algorithm extensions for object death tracking.

## Record Types

Each line in the trace file represents one event. Records are whitespace-separated values.

### Object Allocation (N)

```
N <object-id> <size> <type-id> <site-id> <length> <thread-id>
```

**Description**: Records the allocation of a new object.

**Fields**:
- `object-id`: Unique identifier for this object (integer)
- `size`: Size of object in bytes (long)
- `type-id`: Class/type identifier (integer)
- `site-id`: Allocation site identifier (integer)
- `length`: Reserved field, typically 0 for objects (integer)
- `thread-id`: Thread that allocated the object (long)

**Example**:
```
N 815033865 40 6 58 0 1950409828
```

Allocates object ID 815033865, size 40 bytes, type 6, at site 58, in thread 1950409828.

---

### Array Allocation (A)

```
A <object-id> <size> <type-id> <site-id> <length> <thread-id>
```

**Description**: Records the allocation of a new array.

**Fields**: Same as Object Allocation, but:
- `length`: Number of elements in the array

**Example**:
```
A 1936628443 24 18 68 1 1950409828
```

Allocates array ID 1936628443, size 24 bytes (header + elements), type 18, at site 68, with 1 element, in thread 1950409828.

---

### Object Death (D)

```
D <object-id> <thread-id> <timestamp>
```

**Description**: Records when an object becomes unreachable (generated by Merlin algorithm).

**Fields**:
- `object-id`: ID of the object that died (integer)
- `thread-id`: Thread context when death was detected (long)
- `timestamp`: Nanosecond timestamp when death was detected (long)

**Example**:
```
D 1830908236 1950409828 745397774474461
```

Object 1830908236 died at timestamp 745397774474461 in thread 1950409828.

---

### Field Update (U)

```
U <target-obj-id> <source-obj-id> <field-id> <thread-id>
```

**Description**: Records a pointer field update (target.field = source).

**Fields**:
- `target-obj-id`: Object whose field is being updated (integer, 0 for static fields)
- `source-obj-id`: Object being assigned to the field (integer, 0 for null)
- `field-id`: Identifier for the field (integer)
- `thread-id`: Thread performing the update (long)

**Example**:
```
U 1177096266 670576685 9 1950409828
```

Object 1177096266's field 9 is updated to point to object 670576685.

**Static Field Example**:
```
U 0 1234567 42 1950409828
```

Static field 42 is updated to point to object 1234567.

---

### Method Entry (M)

```
M <method-id> <receiver-obj-id> <thread-id>
```

**Description**: Records method invocation.

**Fields**:
- `method-id`: Unique identifier for the method (integer)
- `receiver-obj-id`: The `this` object for instance methods, 0 for static methods (integer)
- `thread-id`: Thread executing the method (long)

**Example**:
```
M 40 752848266 1950409828
```

Method 40 is called on object 752848266 (or static if receiver is 0) in thread 1950409828.

---

### Method Exit (E)

```
E <method-id> <thread-id>
```

**Description**: Records method return.

**Fields**:
- `method-id`: Identifier of the returning method (integer)
- `thread-id`: Thread executing the method (long)

**Example**:
```
E 40 1950409828
```

Method 40 returns in thread 1950409828.

---

### Exception Throw (T)

```
T <method-id> <receiver-id> <exception-obj-id> <thread-id>
```

**Description**: Records exception being thrown.

**Fields**:
- `method-id`: Method throwing the exception (integer)
- `receiver-id`: The `this` object (integer)
- `exception-obj-id`: The exception object ID (integer)
- `thread-id`: Thread throwing the exception (long)

---

### Exception Handled (H)

```
H <method-id> <receiver-id> <exception-obj-id> <thread-id>
```

**Description**: Records exception being caught and handled.

**Fields**:
- `method-id`: Method handling the exception (integer)
- `receiver-id`: The `this` object (integer)
- `exception-obj-id`: The exception object ID (integer)
- `thread-id`: Thread handling the exception (long)

---

### Exception Exit (X)

```
X <method-id> <receiver-obj-id> <exception-id> <thread-id>
```

**Description**: Records method exiting due to exception.

**Fields**:
- `method-id`: Method exiting (integer)
- `receiver-obj-id`: The `this` object (integer)
- `exception-id`: The exception causing the exit (integer)
- `thread-id`: Thread (long)

---

## Comments and Empty Lines

Lines starting with `#` are comments and are ignored:
```
# This is a comment
```

Empty lines are also ignored.

---

## Complete Example Trace

```
# Sample trace file
M 40 752848266 1950409828
N 815033865 40 6 58 0 1950409828
E 40 1950409828

M 41 752848266 1950409828
A 1936628443 24 18 68 1 1950409828
E 41 1950409828

U 1177096266 670576685 9 1950409828
U 670576685 1299641336 9 1950409828

D 815033865 1950409828 745397774474461
D 1936628443 1950409828 745397774474462
```

**Interpretation**:
1. Method 40 is called on object 752848266
2. Object 815033865 is allocated (40 bytes)
3. Method 40 returns
4. Method 41 is called on object 752848266
5. Array 1936628443 is allocated (24 bytes, 1 element)
6. Method 41 returns
7. Field 9 of object 1177096266 points to object 670576685
8. Field 9 of object 670576685 points to object 1299641336
9. Object 815033865 dies (becomes unreachable)
10. Object 1936628443 dies

---

## Implementation Notes

### For TraceReplayer

- The replayer processes records sequentially
- Object IDs must be unique throughout the trace
- Death records (D) should only reference objects that were previously allocated (N or A)
- Field updates (U) simulate pointer writes for cache behavior analysis
- Method entries/exits (M/E) are tracked for statistics and potential GC trigger points

### For Trace Generation

- Generated by Elephant Tracks instrumentation of Java programs
- Death records added by Merlin algorithm post-processing or real-time tracking
- Object IDs typically derived from Java `System.identityHashCode()`
- Thread IDs are Java thread IDs
- Timestamps are nanosecond-precision

---

## Validation

To validate a trace file:

```bash
# Check record counts
grep "^N " trace | wc -l   # Object allocations
grep "^A " trace | wc -l   # Array allocations
grep "^D " trace | wc -l   # Deaths
grep "^U " trace | wc -l   # Field updates
grep "^M " trace | wc -l   # Method entries
grep "^E " trace | wc -l   # Method exits

# Verify allocations have corresponding fields
head -20 trace

# Check for invalid object IDs (should all be positive)
grep "^[NAD] " trace | awk '{print $2}' | sort -n | head
```

---

## Troubleshooting

### Common Issues

1. **Missing Death Records**: If no `D` records exist, the trace was generated without Merlin integration. GC simulation will not be accurate.

2. **Mismatched Allocations/Deaths**: More deaths than allocations indicates an issue with trace generation.

3. **Invalid Object IDs**: Object ID 0 is reserved for null references and static fields.

4. **Out-of-Order Records**: Deaths should generally occur after allocations, but timing can vary with concurrent threads.

---

## References

- [Elephant Tracks Paper](https://www.cs.tufts.edu/~nr/pubs/et.pdf)
- [Merlin Algorithm](https://cse.buffalo.edu/~mhertz/toplas-2006-merlin.pdf)
- [ET2 Implementation](../README.md)
